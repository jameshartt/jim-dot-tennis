<style>
.player-remove-btn {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
}

.player-remove-btn:hover {
    background: #c82333;
}

.player-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
    cursor: move;
    user-select: none;
    transition: all 0.2s;
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.player-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.player-card.availability-available {
    border-left: 4px solid #28a745;
}

.player-card.availability-ifneeded {
    border-left: 4px solid #ffc107;
}

.player-card.availability-unavailable {
    border-left: 4px solid #dc3545;
}

.player-card.availability-unknown {
    border-left: 4px solid #6c757d;
}
</style>

<div class="team-selection-container">
    <div class="fixture-summary">
        <h1 class="fixture-title">
            {{if .FixtureDetail.Division}}{{.FixtureDetail.Division.Name}}{{else}}Division TBD{{end}}
            {{if .FixtureDetail.Week}} - Week {{.FixtureDetail.Week.WeekNumber}}{{end}}
        </h1>
        <p class="teams-vs">
            <span class="team-name">{{if .FixtureDetail.HomeTeam}}{{.FixtureDetail.HomeTeam.Name}}{{else}}TBD{{end}}</span>
            <span class="vs-text">vs</span>
            <span class="team-name">{{if .FixtureDetail.AwayTeam}}{{.FixtureDetail.AwayTeam.Name}}{{else}}TBD{{end}}</span>
        </p>
        <p class="fixture-date">
            📅 {{.FixtureDetail.ScheduledDate.Format "Monday, January 2, 2006 at 3:04 PM"}}
            📍 {{.FixtureDetail.VenueLocation}}
        </p>
        {{if .ManagingTeam}}
        <p class="managing-team-indicator" style="text-align: center; color: #007bff; font-weight: 600; margin-top: 0.5rem;">
            ⚽ Derby Match - Managing: {{.ManagingTeam.Name}}
        </p>
        {{end}}
    </div>

    <div class="progress-indicator">
        <div class="progress-text">
            {{$selectedCount := len .FixtureDetail.SelectedPlayers}}
            Players Selected: {{$selectedCount}}/8
        </div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{.SelectionPercentage}}%"></div>
        </div>
    </div>

    <div class="combined-layout">
        <div class="team-selection-section">
            <h3>👥 Team Selection</h3>
            
            <div class="selected-players-zone" 
                 id="selected-players-zone" 
                 ondrop="handleDrop(event, 'selected')" 
                 ondragover="handleDragOver(event)">
                <h4>Selected Players</h4>
                <div id="selected-players-container">
                    {{if .FixtureDetail.SelectedPlayers}}
                        {{range .FixtureDetail.SelectedPlayers}}
                        <div class="player-card availability-{{.AvailabilityStatus | lower}}" 
                             draggable="true" 
                             ondragstart="handleDragStart(event, '{{.PlayerID}}', '{{.Player.FirstName}} {{.Player.LastName}}', 'selected')"
                             data-player-id="{{.PlayerID}}"
                             data-player-name="{{.Player.FirstName}} {{.Player.LastName}}"
                             data-availability="{{.AvailabilityStatus | lower}}"
                             title="{{.Player.FirstName}} {{.Player.LastName}} - Status: {{.AvailabilityStatus}}{{if .AvailabilityNotes}} ({{.AvailabilityNotes}}){{end}}">
                            <span>{{.Player.FirstName}} {{.Player.LastName}}</span>
                            <button class="player-remove-btn" onclick="removePlayer('{{.PlayerID}}', 'selected')" title="Remove from selection">×</button>
                        </div>
                        {{end}}
                    {{else}}
                        <div class="no-selection">Drag players here to select them for the team</div>
                    {{end}}
                </div>
            </div>
        </div>

        <div class="matchup-zones-section">
            <h3>🎾 Matchup Assignments</h3>
            
            <div class="matchup-zone" 
                 id="matchup-zone-0" 
                 ondrop="handleDrop(event, '1st Mixed')" 
                 ondragover="handleDragOver(event)"
                 data-matchup-type="1st Mixed">
                <h4>👫 1st Mixed</h4>
                <div class="player-limit">0/2</div>
                <div class="matchup-players" id="matchup-players-0">
                    {{range .FixtureDetail.Matchups}}
                        {{if eq .Matchup.Type "1st Mixed"}}
                            {{range .Players}}
                            <div class="player-card availability-unknown" 
                                 draggable="true" 
                                 ondragstart="handleDragStart(event, '{{.Player.ID}}', '{{.Player.FirstName}} {{.Player.LastName}}', '1st Mixed')"
                                 data-player-id="{{.Player.ID}}"
                                 data-player-name="{{.Player.FirstName}} {{.Player.LastName}}"
                                 data-availability="unknown">
                                <span>{{.Player.FirstName}} {{.Player.LastName}}</span>
                                <button class="player-remove-btn" onclick="removePlayer('{{.Player.ID}}', '1st Mixed')" title="Remove from matchup">×</button>
                            </div>
                            {{end}}
                        {{end}}
                    {{end}}
                </div>
            </div>
            
            <div class="matchup-zone" 
                 id="matchup-zone-1" 
                 ondrop="handleDrop(event, '2nd Mixed')" 
                 ondragover="handleDragOver(event)"
                 data-matchup-type="2nd Mixed">
                <h4>👫 2nd Mixed</h4>
                <div class="player-limit">0/2</div>
                <div class="matchup-players" id="matchup-players-1">
                    {{range .FixtureDetail.Matchups}}
                        {{if eq .Matchup.Type "2nd Mixed"}}
                            {{range .Players}}
                            <div class="player-card availability-unknown" 
                                 draggable="true" 
                                 ondragstart="handleDragStart(event, '{{.Player.ID}}', '{{.Player.FirstName}} {{.Player.LastName}}', '2nd Mixed')"
                                 data-player-id="{{.Player.ID}}"
                                 data-player-name="{{.Player.FirstName}} {{.Player.LastName}}"
                                 data-availability="unknown">
                                <span>{{.Player.FirstName}} {{.Player.LastName}}</span>
                                <button class="player-remove-btn" onclick="removePlayer('{{.Player.ID}}', '2nd Mixed')" title="Remove from matchup">×</button>
                            </div>
                            {{end}}
                        {{end}}
                    {{end}}
                </div>
            </div>
            
            <div class="matchup-zone" 
                 id="matchup-zone-2" 
                 ondrop="handleDrop(event, 'Mens')" 
                 ondragover="handleDragOver(event)"
                 data-matchup-type="Mens">
                <h4>👨‍🤝‍👨 Mens</h4>
                <div class="player-limit">0/2</div>
                <div class="matchup-players" id="matchup-players-2">
                    {{range .FixtureDetail.Matchups}}
                        {{if eq .Matchup.Type "Mens"}}
                            {{range .Players}}
                            <div class="player-card availability-unknown" 
                                 draggable="true" 
                                 ondragstart="handleDragStart(event, '{{.Player.ID}}', '{{.Player.FirstName}} {{.Player.LastName}}', 'Mens')"
                                 data-player-id="{{.Player.ID}}"
                                 data-player-name="{{.Player.FirstName}} {{.Player.LastName}}"
                                 data-availability="unknown">
                                <span>{{.Player.FirstName}} {{.Player.LastName}}</span>
                                <button class="player-remove-btn" onclick="removePlayer('{{.Player.ID}}', 'Mens')" title="Remove from matchup">×</button>
                            </div>
                            {{end}}
                        {{end}}
                    {{end}}
                </div>
            </div>
            
            <div class="matchup-zone" 
                 id="matchup-zone-3" 
                 ondrop="handleDrop(event, 'Womens')" 
                 ondragover="handleDragOver(event)"
                 data-matchup-type="Womens">
                <h4>👩‍🤝‍👩 Womens</h4>
                <div class="player-limit">0/2</div>
                <div class="matchup-players" id="matchup-players-3">
                    {{range .FixtureDetail.Matchups}}
                        {{if eq .Matchup.Type "Womens"}}
                            {{range .Players}}
                            <div class="player-card availability-unknown" 
                                 draggable="true" 
                                 ondragstart="handleDragStart(event, '{{.Player.ID}}', '{{.Player.FirstName}} {{.Player.LastName}}', 'Womens')"
                                 data-player-id="{{.Player.ID}}"
                                 data-player-name="{{.Player.FirstName}} {{.Player.LastName}}"
                                 data-availability="unknown">
                                <span>{{.Player.FirstName}} {{.Player.LastName}}</span>
                                <button class="player-remove-btn" onclick="removePlayer('{{.Player.ID}}', 'Womens')" title="Remove from matchup">×</button>
                            </div>
                            {{end}}
                        {{end}}
                    {{end}}
                </div>
            </div>
        </div>
    </div>

    <div class="available-players-section">
        <h3>🎯 Available Players</h3>
        
        <div class="availability-legend">
            <h5>🎨 Availability Status:</h5>
            <div class="legend-item">
                <span class="legend-color legend-available"></span>
                Available
            </div>
            <div class="legend-item">
                <span class="legend-color legend-ifneeded"></span>
                If Needed
            </div>
            <div class="legend-item">
                <span class="legend-color legend-unavailable"></span>
                Unavailable
            </div>
            <div class="legend-item">
                <span class="legend-color legend-unknown"></span>
                Unknown
            </div>
        </div>
        
        <div class="eligibility-legend">
            <h5>⚖️ Eligibility Status:</h5>
            <div class="legend-item">
                <span class="emoji-unlocked">🔓</span>
                Unlocked - Can play (remaining count shown)
            </div>
            <div class="legend-item">
                <span class="emoji-locked">🔒</span>
                Locked - 4+ matches played (locked to this team or higher)
            </div>
            <div class="legend-item">
                <span class="emoji-blocked">🛑</span>
                Blocked - Rule violation (already played/playing this week) 
            </div>
        </div>
        
        {{if .TeamPlayers}}
        <div class="player-group">
            <h4>Team Players ({{len .TeamPlayers}} available)</h4>
            <div class="player-buttons">
                {{range .TeamPlayers}}
                <form method="post" style="display: inline;"
                      hx-post="/admin/fixtures/{{$.FixtureDetail.ID}}/team-selection"
                      hx-target=".team-selection-container"
                      hx-swap="outerHTML">
                    <input type="hidden" name="action" value="add_player">
                    <input type="hidden" name="player_id" value="{{.Player.ID}}">
                    <input type="hidden" name="is_home" value="true">
                    {{if $.ManagingTeamID}}<input type="hidden" name="managing_team_id" value="{{$.ManagingTeamID}}">{{end}}
                    <button type="submit" class="btn-add-player availability-{{.AvailabilityStatus | lower}}{{if .Eligibility}}{{if not .Eligibility.CanPlay}} btn-blocked{{else if .Eligibility.IsLocked}} btn-locked{{end}}{{end}}"
                            {{if .Eligibility}}{{if not .Eligibility.CanPlay}}disabled{{end}}{{end}}
                            title="{{.Player.FirstName}} {{.Player.LastName}} - Status: {{.AvailabilityStatus}}{{if .AvailabilityNotes}} ({{.AvailabilityNotes}}){{end}}{{if .Eligibility}}{{if not .Eligibility.CanPlay}} 🛑 {{if .Eligibility.PlayedThisWeek}}Already played this week for {{.Eligibility.PlayedThisWeekTeam}}{{else if .Eligibility.IsLockedToHigherTeam}}Locked to {{.Eligibility.LockedToTeamName}}{{end}}{{else if .Eligibility.IsLocked}} 🔒 Locked to this team or higher{{else if .Eligibility.CanPlayLower}} 🔓 {{if ge .Eligibility.RemainingHigherTeamPlays 0}}{{.Eligibility.RemainingHigherTeamPlays}} plays left{{else}}Can play lower teams{{end}}{{end}}{{end}}">
                        {{if .Eligibility}}{{if not .Eligibility.CanPlay}}<span class="emoji-blocked">🛑</span>{{else if .Eligibility.IsLocked}}<span class="emoji-locked">🔒</span>{{else if .Eligibility.CanPlayLower}}<span class="emoji-unlocked">🔓</span>{{end}}{{end}} {{.Player.FirstName}} {{.Player.LastName}}{{if .Eligibility}}{{if and .Eligibility.CanPlayLower (ge .Eligibility.RemainingHigherTeamPlays 0)}} ({{.Eligibility.RemainingHigherTeamPlays}} left){{end}}{{end}}
                    </button>
                </form>
                {{end}}
            </div>
        </div>
        {{else}}
        <div class="player-group">
            <h4>Team Players</h4>
            <p class="no-players">No team players available.</p>
        </div>
        {{end}}
        
        {{if .AllStAnnPlayers}}
        <div class="player-group">
            <h4>Other St Ann Players ({{len .AllStAnnPlayers}} available)</h4>
            <div class="player-buttons">
                {{range .AllStAnnPlayers}}
                <form method="post" style="display: inline;"
                      hx-post="/admin/fixtures/{{$.FixtureDetail.ID}}/team-selection"
                      hx-target=".team-selection-container"
                      hx-swap="outerHTML">
                    <input type="hidden" name="action" value="add_player">
                    <input type="hidden" name="player_id" value="{{.Player.ID}}">
                    <input type="hidden" name="is_home" value="true">
                    {{if $.ManagingTeamID}}<input type="hidden" name="managing_team_id" value="{{$.ManagingTeamID}}">{{end}}
                    <button type="submit" class="btn-add-player availability-{{.AvailabilityStatus | lower}}{{if .Eligibility}}{{if not .Eligibility.CanPlay}} btn-blocked{{else if .Eligibility.IsLocked}} btn-locked{{end}}{{end}}"
                            {{if .Eligibility}}{{if not .Eligibility.CanPlay}}disabled{{end}}{{end}}
                            title="{{.Player.FirstName}} {{.Player.LastName}} - Status: {{.AvailabilityStatus}}{{if .AvailabilityNotes}} ({{.AvailabilityNotes}}){{end}}{{if .Eligibility}}{{if not .Eligibility.CanPlay}} 🛑 {{if .Eligibility.PlayedThisWeek}}Already played this week for {{.Eligibility.PlayedThisWeekTeam}}{{else if .Eligibility.IsLockedToHigherTeam}}Locked to {{.Eligibility.LockedToTeamName}}{{end}}{{else if .Eligibility.IsLocked}} 🔒 Locked to this team or higher{{else if .Eligibility.CanPlayLower}} 🔓 {{if ge .Eligibility.RemainingHigherTeamPlays 0}}{{.Eligibility.RemainingHigherTeamPlays}} plays left{{else}}Can play lower teams{{end}}{{end}}{{end}}">
                        {{if .Eligibility}}{{if not .Eligibility.CanPlay}}<span class="emoji-blocked">🛑</span>{{else if .Eligibility.IsLocked}}<span class="emoji-locked">🔒</span>{{else if .Eligibility.CanPlayLower}}<span class="emoji-unlocked">🔓</span>{{end}}{{end}} {{.Player.FirstName}} {{.Player.LastName}}{{if .Eligibility}}{{if and .Eligibility.CanPlayLower (ge .Eligibility.RemainingHigherTeamPlays 0)}} ({{.Eligibility.RemainingHigherTeamPlays}} left){{end}}{{end}}
                    </button>
                </form>
                {{end}}
            </div>
        </div>
        {{else}}
        <p class="no-players">No other available players found.</p>
        {{end}}
    </div>
</div> 