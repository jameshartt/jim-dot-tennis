<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Selection - {{if .FixtureDetail.HomeTeam}}{{.FixtureDetail.HomeTeam.Name}}{{else}}TBD{{end}} vs {{if .FixtureDetail.AwayTeam}}{{.FixtureDetail.AwayTeam.Name}}{{else}}TBD{{end}} - Jim.Tennis Admin</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <script src="https://unpkg.com/htmx.org@1.9.4"></script>
    <link rel="icon" type="image/png" href="/static/img/favicon.png">
    <style>
        .admin-header {
            background: var(--primary-color);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        .breadcrumb {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .breadcrumb a {
            color: #ffffff80;
            text-decoration: none;
        }
        .breadcrumb a:hover {
            color: white;
        }
        .admin-content {
            padding: 0 1rem;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .btn-back {
            background: var(--secondary-color);
            color: white;
            padding: 0.5rem 1rem;
            text-decoration: none;
            border-radius: 4px;
        }
        
        .team-selection-container {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .fixture-summary {
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .fixture-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
            color: var(--primary-color);
        }
        
        .teams-vs {
            font-size: 1.2rem;
            color: #495057;
            margin: 0 0 0.5rem 0;
        }
        
        .vs-text {
            color: #6c757d;
            font-weight: normal;
            margin: 0 1rem;
        }
        
        .fixture-date {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .combined-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .team-selection-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .team-selection-section h3 {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .selected-players-zone {
            background: #fff;
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            min-height: 120px;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        .selected-players-zone.drag-over {
            background: #e3f2fd;
            border-color: #0056b3;
        }
        
        .selected-players-zone h4 {
            margin: 0 0 0.5rem 0;
            color: #007bff;
            font-size: 1rem;
        }
        
        .selected-player-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .player-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            cursor: move;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .player-card > span {
            flex: 1;
            word-wrap: break-word;
            line-height: 1.2;
        }
        
        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .player-card.dragging {
            opacity: 0.5;
            user-select: none !important;
            -webkit-user-select: none !important;
            -webkit-touch-callout: none !important;
        }
        
        .player-remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            flex-shrink: 0;
            align-self: flex-start;
        }
        
        .player-remove-btn:hover {
            background: #c82333;
        }
        
        /* Availability status colors for player cards */
        .player-card.availability-available {
            border-left: 4px solid #28a745;
        }
        
        .player-card.availability-ifneeded {
            border-left: 4px solid #ffc107;
        }
        
        .player-card.availability-unavailable {
            border-left: 4px solid #dc3545;
        }
        
        .player-card.availability-unknown {
            border-left: 4px solid #6c757d;
        }
        
        /* Remove drag styling from matchup zone player cards */
        .matchup-zone .player-card {
            cursor: pointer !important;
        }
        
        .matchup-zone .player-card:hover {
            transform: none !important;
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .matchup-zone .player-card::after {
            content: "‚úï";
            color: #dc3545;
            font-size: 12px;
            margin-left: auto;
            opacity: 0.7;
        }
        
        .matchup-zone .player-card:hover::after {
            opacity: 1;
        }
        
        .matchup-zones-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid #28a745;
        }
        
        .matchup-zones-section h3 {
            margin: 0 0 1rem 0;
            color: #28a745;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .matchup-zone {
            background: white;
            border: 2px dashed #28a745;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            min-height: 80px;
            transition: all 0.3s ease;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        .matchup-zone.drag-over {
            background: #e8f5e8;
            border-color: #1e7e34;
        }
        
        .matchup-zone h4 {
            margin: 0 0 0.5rem 0;
            color: #28a745;
            font-size: 1rem;
        }
        
        .matchup-zone .player-limit {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .matchup-zone.over-limit {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        .matchup-players {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .available-players-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid #17a2b8;
            margin-top: 1rem;
        }
        
        .available-players-section h3 {
            margin: 0 0 1rem 0;
            color: #17a2b8;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .player-group {
            margin-bottom: 2rem;
        }
        
        .player-group h4 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        .player-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .btn-add-player {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            user-select: none;
        }
        
        .btn-add-player:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-add-player:active {
            transform: translateY(0);
        }
        
        /* Availability status colors for add buttons */
        .btn-add-player.availability-available {
            background: #28a745;
            border-left: 4px solid #1e7e34;
        }
        
        .btn-add-player.availability-available:hover {
            background: #218838;
        }
        
        .btn-add-player.availability-ifneeded {
            background: #ffc107;
            color: #212529;
            border-left: 4px solid #d39e00;
        }
        
        .btn-add-player.availability-ifneeded:hover {
            background: #e0a800;
        }
        
        .btn-add-player.availability-unavailable {
            background: #dc3545;
            border-left: 4px solid #bd2130;
        }
        
        .btn-add-player.availability-unavailable:hover {
            background: #c82333;
        }
        
        .btn-add-player.availability-unknown {
            background: #6c757d;
            border-left: 4px solid #545b62;
        }
        
        .btn-add-player.availability-unknown:hover {
            background: #5a6268;
        }
        
        .btn-blocked {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Removed empty rulesets to satisfy linter */
        
        .availability-legend {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }
        
        .availability-legend h5 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }
        
        .legend-item {
            display: inline-block;
            margin-right: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 4px;
            vertical-align: middle;
        }
        
        .legend-available { background: #28a745; }
        .legend-ifneeded { background: #ffc107; }
        .legend-unavailable { background: #dc3545; }
        .legend-unknown { background: #6c757d; }
        
        /* Day Captain Selection */
        .matchup-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .btn-captain-selector {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        
        .btn-captain-selector:hover {
            background: #138496;
        }
        
        .btn-captain-selector.active {
            background: #dc3545;
        }
        
        .btn-captain-selector.active:hover {
            background: #c82333;
        }
        
        .player-card.captain-selectable {
            cursor: pointer;
            border: 2px solid #17a2b8;
            background: #e3f2fd;
            transform: scale(1.02);
        }
        
        .player-card.captain-selectable:hover {
            border-color: #138496;
            background: #bbdefb;
        }
        
        .player-card.is-captain {
            border-left: 4px solid #ffc107;
        }
        
        .player-card.is-captain .player-name {
            font-weight: 700;
        }
        
        .captain-indicator {
            font-weight: 700;
            color: #ffc107;
            margin-left: 0.25rem;
        }
        
        /* Hide matchup zone crosses during captain selection */
        .captain-selection-mode .matchup-zone .player-card::after {
            display: none !important;
        }
        
        .captain-selection-mode .matchup-zone .player-card:hover::after {
            display: none !important;
        }
        
        .emoji-unlocked { font-size: 1.1em; }
        .emoji-locked { font-size: 1.1em; }
        .emoji-blocked { font-size: 1.1em; }
        
        .eligibility-legend {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }
        
        .eligibility-legend h5 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }
        
        .no-players {
            color: #6c757d;
            font-style: italic;
            margin: 1rem 0;
        }
        
        .no-selection {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            margin: 2rem 0;
        }
        
        .progress-indicator {
            background: #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin: 0.5rem 0;
            overflow: hidden;
        }
        
        .progress-fill {
            background: var(--primary-color);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 0.9rem;
            color: #495057;
        }
        
        /* Available players header row */
        .available-players-header-row {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        /* Forced selection toggle (iOS-style switch) */
        .forced-toggle {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .forced-toggle label.text {
            color: #495057;
            font-size: 0.9rem;
            user-select: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .2s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 2px;
            bottom: 2px;
            background-color: #fff;
            transition: .2s;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .switch input:checked + .slider { background-color: #28a745; }
        .switch input:focus + .slider { box-shadow: 0 0 1px #28a745; }
        .switch input:checked + .slider:before { transform: translateX(20px); }

        /* Visual hint when a blocked button is enabled by forced selection */
        .btn-add-player.forced-enabled {
            outline: 2px dashed #17a2b8;
            outline-offset: 2px;
        }

        .drag-placeholder {
            background: #f8f9fa;
            border: 2px dashed #6c757d;
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.25rem 0;
            color: #6c757d;
            font-style: italic;
            text-align: center;
            display: none;
        }
        
        .drag-placeholder.show {
            display: block;
        }
        
        @media (max-width: 1024px) {
            .combined-layout {
                grid-template-columns: 1fr 1fr;
                gap: 0.25rem;
            }
            
            .fixture-title {
                font-size: 1.2rem;
                margin: 0 0 0.25rem 0;
            }
            
            .teams-vs {
                font-size: 0.95rem;
                margin: 0 0 0.25rem 0;
            }
            
            .fixture-date {
                font-size: 0.85rem;
                margin: 0;
            }
            
            .admin-content {
                padding: 0 0.25rem;
            }
            
            .team-selection-container {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
            }
            
            .team-selection-section,
            .matchup-zones-section,
            .available-players-section {
                padding: 0.5rem;
                margin-bottom: 0.25rem;
            }
            
            .selected-players-zone,
            .matchup-zone {
                padding: 0.3rem;
                min-height: 50px;
                margin-bottom: 0.25rem;
            }
            
            .player-card {
                touch-action: pan-y; /* Allow vertical scrolling */
                padding: 0.3rem 0.5rem;
                font-size: 0.85rem;
                margin-bottom: 0.2rem;
            }
            
            .player-remove-btn {
                width: 22px;
                height: 22px;
                font-size: 12px;
                touch-action: manipulation; /* Improve touch responsiveness */
                flex-shrink: 0;
                align-self: flex-start;
            }
            
            .player-buttons {
                flex-direction: column;
                gap: 0.2rem;
            }
            
            .btn-add-player {
                text-align: center;
                padding: 0.5rem;
                font-size: 0.85rem;
                touch-action: manipulation;
            }
            
            .fixture-summary {
                padding-bottom: 0.5rem;
                margin-bottom: 0.5rem;
            }
            
            .progress-indicator {
                padding: 0.3rem;
                margin-bottom: 0.5rem;
            }
            
            .availability-legend,
            .eligibility-legend {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                font-size: 0.9rem;
            }
            
            .legend-item {
                display: block;
                margin-bottom: 0.4rem;
            }
            
            .player-group {
                margin-bottom: 1rem;
            }
            
            .player-group h4 {
                margin-bottom: 0.5rem;
                font-size: 0.9rem;
            }
            
            /* Smaller headers on mobile */
            .team-selection-section h3,
            .matchup-zones-section h3,
            .available-players-section h3 {
                font-size: 0.9rem;
                margin: 0 0 0.3rem 0;
                font-weight: 600;
            }
            
            .matchup-zone h4 {
                font-size: 0.8rem;
                margin: 0 0 0.2rem 0;
            }
            
            .selected-players-zone h4 {
                display: none; /* Hide "Selected Players" title on mobile */
            }
            
            /* Mobile-specific drag feedback */
            .player-card.mobile-drag-ready {
                background: #e3f2fd;
                transform: scale(1.02);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                user-select: none !important;
                -webkit-user-select: none !important;
                -webkit-touch-callout: none !important;
            }
            
            .drag-instruction {
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 0.3rem 0.8rem;
                border-radius: 4px;
                font-size: 0.75rem;
                z-index: 1000;
                display: none;
            }
            
            .drag-instruction.show {
                display: block;
            }
            
            .drag-instruction-text {
                font-size: 0.75rem !important;
                margin-top: 0.3rem !important;
            }
            
            .matchup-header-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            
            .btn-captain-selector {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
        }
        
        /* Even more compact for landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .fixture-summary {
                padding-bottom: 0.3rem;
                margin-bottom: 0.3rem;
            }
            
            .fixture-title {
                font-size: 1.1rem;
            }
            
            .teams-vs {
                font-size: 0.9rem;
            }
            
            .fixture-date {
                font-size: 0.8rem;
            }
            
            .progress-indicator {
                padding: 0.2rem;
                margin-bottom: 0.3rem;
            }
            
            .team-selection-section,
            .matchup-zones-section,
            .available-players-section {
                padding: 0.3rem;
            }
            
            .selected-players-zone,
            .matchup-zone {
                padding: 0.2rem;
                min-height: 40px;
            }
            
            .player-card {
                padding: 0.25rem 0.4rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="container">
            <div class="breadcrumb">
                <a href="/admin">Admin Dashboard</a> &gt; 
                <a href="/admin/fixtures">Fixtures</a> &gt; 
                {{if .ManagingTeam}}
                <a href="/admin/fixtures/{{.FixtureDetail.ID}}?managingTeam={{.ManagingTeam.ID}}&teamName={{.ManagingTeam.Name}}">Fixture Detail</a> &gt;
                {{else}}
                <a href="/admin/fixtures/{{.FixtureDetail.ID}}">Fixture Detail</a> &gt;
                {{end}}
                Team Selection
            </div>
        </div>
    </header>

    <main class="admin-content">
        <div class="container">
            <div class="action-bar">
                <h2>Team Selection & Matchups</h2>
                {{if .ManagingTeam}}
                <a href="/admin/fixtures/{{.FixtureDetail.ID}}?managingTeam={{.ManagingTeam.ID}}&teamName={{.ManagingTeam.Name}}" class="btn-back">‚Üê Back to Fixture</a>
                {{else}}
                <a href="/admin/fixtures/{{.FixtureDetail.ID}}" class="btn-back">‚Üê Back to Fixture</a>
                {{end}}
            </div>

            <div class="team-selection-container">
                <div class="fixture-summary">
                    <h1 class="fixture-title">
                        {{if .FixtureDetail.Division}}{{.FixtureDetail.Division.Name}}{{else}}Division TBD{{end}}
                        {{if .FixtureDetail.Week}} - Week {{.FixtureDetail.Week.WeekNumber}}{{end}}
                    </h1>
                    <p class="teams-vs">
                        <span class="team-name">{{if .FixtureDetail.HomeTeam}}{{.FixtureDetail.HomeTeam.Name}}{{else}}TBD{{end}}</span>
                        <span class="vs-text">vs</span>
                        <span class="team-name">{{if .FixtureDetail.AwayTeam}}{{.FixtureDetail.AwayTeam.Name}}{{else}}TBD{{end}}</span>
                    </p>
                    <p class="fixture-date">
                        üìÖ {{.FixtureDetail.ScheduledDate.Format "Monday, January 2, 2006 at 3:04 PM"}}
                        üìç {{.FixtureDetail.VenueLocation}}
                    </p>
                    {{if .ManagingTeam}}
                    <p class="managing-team-indicator" style="text-align: center; color: #007bff; font-weight: 600; margin-top: 0.5rem;">
                        ‚öΩ Derby Match - Managing: {{.ManagingTeam.Name}}
                    </p>
                    {{end}}
                </div>

                <div class="progress-indicator">
                    <div class="progress-text">
                        {{$selectedCount := len .FixtureDetail.SelectedPlayers}}
                        Players Selected: {{$selectedCount}}/8
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" data-percentage="{{.SelectionPercentage}}"></div>
                    </div>
                </div>

                <div class="combined-layout">
                    <div class="team-selection-section">
                        <h3>üë• Team Selection</h3>
                        
                        <div class="selected-players-zone" 
                             id="selected-players-zone" 
                             ondrop="handleDrop(event, 'selected')" 
                             ondragover="handleDragOver(event)">
                            <h4>Selected Players</h4>
                            <div id="selected-players-container">
                                {{if .FixtureDetail.SelectedPlayers}}
                                    {{range .FixtureDetail.SelectedPlayers}}
                                    <div class="player-card availability-{{.AvailabilityStatus | lower}}{{if and $.FixtureDetail.DayCaptain (eq .PlayerID $.FixtureDetail.DayCaptain.ID)}} is-captain{{end}}" 
                                         draggable="true" 
                                         ondragstart="handleDragStart(event, '{{.PlayerID}}', '{{.Player.FirstName}} {{.Player.LastName}}', 'selected')"
                                         data-player-id="{{.PlayerID}}"
                                         data-player-name="{{.Player.FirstName}} {{.Player.LastName}}"
                                         data-availability="{{.AvailabilityStatus | lower}}"
                                         title="{{.Player.FirstName}} {{.Player.LastName}} - Status: {{.AvailabilityStatus}}{{if .AvailabilityNotes}} ({{.AvailabilityNotes}}){{end}}">
                                        <span class="player-name">{{.Player.FirstName}} {{.Player.LastName}}{{if and $.FixtureDetail.DayCaptain (eq .PlayerID $.FixtureDetail.DayCaptain.ID)}}<span class="captain-indicator">(C)</span>{{end}}</span>
                                        <button class="player-remove-btn" onclick="removePlayer('{{.PlayerID}}', 'selected')" title="Remove from selection">√ó</button>
                                    </div>
                                    {{end}}
                                {{else}}
                                    <div class="no-selection">Select players below to add to your team</div>
                                {{end}}
                            </div>
                            {{if .FixtureDetail.SelectedPlayers}}
                            <div class="drag-instruction-text" style="text-align: center; font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem; font-style: italic;">
                                üí° Drag players to matchup assignments ‚Üí
                            </div>
                            {{end}}
                        </div>
                    </div>

                    <div class="matchup-zones-section">
                        <div class="matchup-header-row">
                            <h3>üéæ Matchup Assignments</h3>
                            <button id="captain-selector-btn" class="btn-captain-selector" onclick="toggleCaptainSelection()">
                                üë®‚Äç‚úàÔ∏è Select Day Captain
                            </button>
                        </div>
                        
                        <div class="matchup-zone" 
                             id="matchup-zone-0" 
                             ondrop="handleDrop(event, '1st Mixed')" 
                             ondragover="handleDragOver(event)"
                             data-matchup-type="1st Mixed">
                            <h4>üë´ 1st Mixed</h4>
                            <div class="player-limit">0/2</div>
                            <div class="matchup-players" id="matchup-players-0">
                                {{range .FixtureDetail.Matchups}}
                                    {{if eq .Matchup.Type "1st Mixed"}}
                                        {{range .Players}}
                                        <div class="player-card availability-unknown{{if and $.FixtureDetail.DayCaptain (eq .Player.ID $.FixtureDetail.DayCaptain.ID)}} is-captain{{end}}" 
                                             data-player-id="{{.Player.ID}}"
                                             data-player-name="{{.Player.FirstName}} {{.Player.LastName}}"
                                             data-availability="unknown"
                                             onclick="removePlayer('{{.Player.ID}}', '1st Mixed')" 
                                             title="Tap to remove from matchup">
                                            <span class="player-name">{{.Player.FirstName}} {{.Player.LastName}}{{if and $.FixtureDetail.DayCaptain (eq .Player.ID $.FixtureDetail.DayCaptain.ID)}}<span class="captain-indicator">(C)</span>{{end}}</span>
                                        </div>
                                        {{end}}
                                    {{end}}
                                {{end}}
                            </div>
                        </div>
                        
                        <div class="matchup-zone" 
                             id="matchup-zone-1" 
                             ondrop="handleDrop(event, '2nd Mixed')" 
                             ondragover="handleDragOver(event)"
                             data-matchup-type="2nd Mixed">
                            <h4>üë´ 2nd Mixed</h4>
                            <div class="player-limit">0/2</div>
                            <div class="matchup-players" id="matchup-players-1">
                                {{range .FixtureDetail.Matchups}}
                                    {{if eq .Matchup.Type "2nd Mixed"}}
                                        {{range .Players}}
                                        <div class="player-card availability-unknown{{if and $.FixtureDetail.DayCaptain (eq .Player.ID $.FixtureDetail.DayCaptain.ID)}} is-captain{{end}}" 
                                             data-player-id="{{.Player.ID}}"
                                             data-player-name="{{.Player.FirstName}} {{.Player.LastName}}"
                                             data-availability="unknown"
                                             onclick="removePlayer('{{.Player.ID}}', '2nd Mixed')" 
                                             title="Tap to remove from matchup">
                                            <span class="player-name">{{.Player.FirstName}} {{.Player.LastName}}{{if and $.FixtureDetail.DayCaptain (eq .Player.ID $.FixtureDetail.DayCaptain.ID)}}<span class="captain-indicator">(C)</span>{{end}}</span>
                                        </div>
                                        {{end}}
                                    {{end}}
                                {{end}}
                            </div>
                        </div>
                        
                        <div class="matchup-zone" 
                             id="matchup-zone-2" 
                             ondrop="handleDrop(event, 'Mens')" 
                             ondragover="handleDragOver(event)"
                             data-matchup-type="Mens">
                            <h4>üë®‚Äçü§ù‚Äçüë® Mens</h4>
                            <div class="player-limit">0/2</div>
                            <div class="matchup-players" id="matchup-players-2">
                                {{range .FixtureDetail.Matchups}}
                                    {{if eq .Matchup.Type "Mens"}}
                                        {{range .Players}}
                                        <div class="player-card availability-unknown{{if and $.FixtureDetail.DayCaptain (eq .Player.ID $.FixtureDetail.DayCaptain.ID)}} is-captain{{end}}" 
                                             data-player-id="{{.Player.ID}}"
                                             data-player-name="{{.Player.FirstName}} {{.Player.LastName}}"
                                             data-availability="unknown"
                                             onclick="removePlayer('{{.Player.ID}}', 'Mens')" 
                                             title="Tap to remove from matchup">
                                            <span class="player-name">{{.Player.FirstName}} {{.Player.LastName}}{{if and $.FixtureDetail.DayCaptain (eq .Player.ID $.FixtureDetail.DayCaptain.ID)}}<span class="captain-indicator">(C)</span>{{end}}</span>
                                        </div>
                                        {{end}}
                                    {{end}}
                                {{end}}
                            </div>
                        </div>
                        
                        <div class="matchup-zone" 
                             id="matchup-zone-3" 
                             ondrop="handleDrop(event, 'Womens')" 
                             ondragover="handleDragOver(event)"
                             data-matchup-type="Womens">
                            <h4>üë©‚Äçü§ù‚Äçüë© Womens</h4>
                            <div class="player-limit">0/2</div>
                            <div class="matchup-players" id="matchup-players-3">
                                {{range .FixtureDetail.Matchups}}
                                    {{if eq .Matchup.Type "Womens"}}
                                        {{range .Players}}
                                        <div class="player-card availability-unknown{{if and $.FixtureDetail.DayCaptain (eq .Player.ID $.FixtureDetail.DayCaptain.ID)}} is-captain{{end}}" 
                                             data-player-id="{{.Player.ID}}"
                                             data-player-name="{{.Player.FirstName}} {{.Player.LastName}}"
                                             data-availability="unknown"
                                             onclick="removePlayer('{{.Player.ID}}', 'Womens')" 
                                             title="Tap to remove from matchup">
                                            <span class="player-name">{{.Player.FirstName}} {{.Player.LastName}}{{if and $.FixtureDetail.DayCaptain (eq .Player.ID $.FixtureDetail.DayCaptain.ID)}}<span class="captain-indicator">(C)</span>{{end}}</span>
                                        </div>
                                        {{end}}
                                    {{end}}
                                {{end}}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="available-players-section">
                    <div class="available-players-header-row">
                        <h3>üéØ Available Players</h3>
                        <div class="forced-toggle" title="Allow selecting players locked to a higher team">
                            <label class="text">Forced selection</label>
                            <label class="switch">
                                <input type="checkbox" id="forced-selection-toggle" onchange="toggleForcedSelection()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="availability-legend">
                        <h5>üé® Availability Status:</h5>
                        <div class="legend-item">
                            <span class="legend-color legend-available"></span>
                            Available
                        </div>
                        <div class="legend-item">
                            <span class="legend-color legend-ifneeded"></span>
                            If Needed
                        </div>
                        <div class="legend-item">
                            <span class="legend-color legend-unavailable"></span>
                            Unavailable
                        </div>
                        <div class="legend-item">
                            <span class="legend-color legend-unknown"></span>
                            Unknown
                        </div>
                    </div>
                    
                    <div class="eligibility-legend">
                        <h5>‚öñÔ∏è Eligibility Status:</h5>
                        <div class="legend-item">
                            <span>‚úÖ</span>
                            Free to play - Can play in lower divisions (remaining count shown)
                        </div>
                        <div class="legend-item">
                            <span>üîí</span>
                            Locked - 4+ matches played (locked to this team or higher)
                        </div>
                        <div class="legend-item">
                            <span>‚ö†Ô∏è</span>
                            Warning - Already played this week (rule suggestion, can still select)
                        </div>
                        <div class="legend-item">
                            <span>üö´</span>
                            Blocked - Locked to higher division team
                        </div>
                    </div>
                    
                    {{if .TeamPlayers}}
                    <div class="player-group">
                        <h4>Team Players ({{len .TeamPlayers}} available)</h4>
                        <div class="player-buttons">
                            {{range .TeamPlayers}}
                            <form method="post" style="display: inline;"
                                  hx-post="/admin/fixtures/{{$.FixtureDetail.ID}}/team-selection"
                                  hx-target=".team-selection-container"
                                  hx-swap="outerHTML">
                                <input type="hidden" name="action" value="add_player">
                                <input type="hidden" name="player_id" value="{{.Player.ID}}">
                                <input type="hidden" name="is_home" value="true">
                                {{if $.ManagingTeam}}<input type="hidden" name="managing_team_id" value="{{$.ManagingTeam.ID}}">{{end}}
                                
                                {{/* Build CSS classes */}}
                                {{$btnClass := printf "btn-add-player availability-%s" (.AvailabilityStatus | lower)}}
                                {{if .Eligibility}}
                                  {{if and (not .Eligibility.CanPlay) .Eligibility.IsLockedToHigherTeam}}
                                    {{$btnClass = printf "%s btn-blocked" $btnClass}}
                                  {{else if .Eligibility.IsLocked}}
                                    {{$btnClass = printf "%s btn-locked" $btnClass}}
                                  {{end}}
                                {{end}}
                                
                                {{/* Build title with availability and eligibility info */}}
                                {{$title := printf "%s %s - %s" .Player.FirstName .Player.LastName .AvailabilityStatus}}
                                {{if .AvailabilityNotes}}
                                  {{$title = printf "%s (%s)" $title .AvailabilityNotes}}
                                {{end}}
                                {{if .Eligibility}}
                                  {{if not .Eligibility.CanPlay}}
                                    {{if .Eligibility.PlayedThisWeek}}
                                      {{$title = printf "%s | ‚ö†Ô∏è Already played this week for %s (rule suggestion)" $title .Eligibility.PlayedThisWeekTeam}}
                                    {{else if .Eligibility.IsLockedToHigherTeam}}
                                      {{$title = printf "%s | üö´ Locked to %s" $title .Eligibility.LockedToTeamName}}
                                    {{end}}
                                  {{else if .Eligibility.IsLocked}}
                                    {{$title = printf "%s | üîí Locked to this team or higher" $title}}
                                  {{else if .Eligibility.CanPlayLower}}
                                    {{if ge .Eligibility.RemainingHigherTeamPlays 0}}
                                      {{$title = printf "%s | ‚úÖ %d plays left" $title .Eligibility.RemainingHigherTeamPlays}}
                                    {{else}}
                                      {{$title = printf "%s | ‚úÖ Can play lower teams" $title}}
                                    {{end}}
                                  {{end}}
                                {{end}}
                                
                                {{/* Build button text with icon and remaining plays */}}
                                {{$icon := ""}}
                                {{if .Eligibility}}
                                  {{if and (not .Eligibility.CanPlay) .Eligibility.PlayedThisWeek}}
                                    {{$icon = "‚ö†Ô∏è"}}
                                  {{else if and (not .Eligibility.CanPlay) .Eligibility.IsLockedToHigherTeam}}
                                    {{$icon = "üö´"}}
                                  {{else if .Eligibility.IsLocked}}
                                    {{$icon = "üîí"}}
                                  {{else if .Eligibility.CanPlayLower}}
                                    {{$icon = "‚úÖ"}}
                                  {{end}}
                                {{end}}
                                
                                {{$remainingText := ""}}
                                {{if .Eligibility}}
                                  {{if and .Eligibility.CanPlayLower (ge .Eligibility.RemainingHigherTeamPlays 0)}}
                                    {{$remainingText = printf " (%d left)" .Eligibility.RemainingHigherTeamPlays}}
                                  {{end}}
                                {{end}}
                                
                                <button type="submit" 
                                        class="{{$btnClass}}"
                                        {{if and .Eligibility (not .Eligibility.CanPlay) .Eligibility.IsLockedToHigherTeam}}disabled{{end}}
                                        title="{{$title}}">
                                    {{$icon}} {{.Player.FirstName}} {{.Player.LastName}}{{$remainingText}}
                                </button>
                            </form>
                            {{end}}
                        </div>
                    </div>
                    {{else}}
                    <div class="player-group">
                        <h4>Team Players</h4>
                        <p class="no-players">No team players available.</p>
                    </div>
                    {{end}}
                    
                    {{if .AllStAnnPlayers}}
                    <div class="player-group">
                        <h4>Other St Ann Players ({{len .AllStAnnPlayers}} available)</h4>
                        <div class="player-buttons">
                            {{range .AllStAnnPlayers}}
                            <form method="post" style="display: inline;"
                                  hx-post="/admin/fixtures/{{$.FixtureDetail.ID}}/team-selection"
                                  hx-target=".team-selection-container"
                                  hx-swap="outerHTML">
                                <input type="hidden" name="action" value="add_player">
                                <input type="hidden" name="player_id" value="{{.Player.ID}}">
                                <input type="hidden" name="is_home" value="true">
                                {{if $.ManagingTeam}}<input type="hidden" name="managing_team_id" value="{{$.ManagingTeam.ID}}">{{end}}
                                
                                {{/* Build CSS classes */}}
                                {{$btnClass := printf "btn-add-player availability-%s" (.AvailabilityStatus | lower)}}
                                {{if .Eligibility}}
                                  {{if and (not .Eligibility.CanPlay) .Eligibility.IsLockedToHigherTeam}}
                                    {{$btnClass = printf "%s btn-blocked" $btnClass}}
                                  {{else if .Eligibility.IsLocked}}
                                    {{$btnClass = printf "%s btn-locked" $btnClass}}
                                  {{end}}
                                {{end}}
                                
                                {{/* Build title with availability and eligibility info */}}
                                {{$title := printf "%s %s - %s" .Player.FirstName .Player.LastName .AvailabilityStatus}}
                                {{if .AvailabilityNotes}}
                                  {{$title = printf "%s (%s)" $title .AvailabilityNotes}}
                                {{end}}
                                {{if .Eligibility}}
                                  {{if not .Eligibility.CanPlay}}
                                    {{if .Eligibility.PlayedThisWeek}}
                                      {{$title = printf "%s | ‚ö†Ô∏è Already played this week for %s (rule suggestion)" $title .Eligibility.PlayedThisWeekTeam}}
                                    {{else if .Eligibility.IsLockedToHigherTeam}}
                                      {{$title = printf "%s | üö´ Locked to %s" $title .Eligibility.LockedToTeamName}}
                                    {{end}}
                                  {{else if .Eligibility.IsLocked}}
                                    {{$title = printf "%s | üîí Locked to this team or higher" $title}}
                                  {{else if .Eligibility.CanPlayLower}}
                                    {{if ge .Eligibility.RemainingHigherTeamPlays -1}}
                                      {{$title = printf "%s | ‚úÖ %d plays left" $title .Eligibility.RemainingHigherTeamPlays}}
                                    {{else}}
                                      {{$title = printf "%s | ‚úÖ Can play lower teams" $title}}
                                    {{end}}
                                  {{end}}
                                {{end}}
                                
                                {{/* Build button text with icon and remaining plays */}}
                                {{$icon := ""}}
                                {{if .Eligibility}}
                                  {{if and (not .Eligibility.CanPlay) .Eligibility.PlayedThisWeek}}
                                    {{$icon = "‚ö†Ô∏è"}}
                                  {{else if and (not .Eligibility.CanPlay) .Eligibility.IsLockedToHigherTeam}}
                                    {{$icon = "üö´"}}
                                  {{else if .Eligibility.IsLocked}}
                                    {{$icon = "üîí"}}
                                  {{else if .Eligibility.CanPlayLower}}
                                    {{$icon = "‚úÖ"}}
                                  {{end}}
                                {{end}}
                                
                                {{$remainingText := ""}}
                                {{if .Eligibility}}
                                  {{if and .Eligibility.CanPlayLower (ge .Eligibility.RemainingHigherTeamPlays -1)}}
                                    {{$remainingText = printf " (%d left)" .Eligibility.RemainingHigherTeamPlays}}
                                  {{end}}
                                {{end}}
                                
                                <button type="submit" 
                                        class="{{$btnClass}}"
                                        {{if and .Eligibility (not .Eligibility.CanPlay) .Eligibility.IsLockedToHigherTeam}}disabled{{end}}
                                        title="{{$title}}">
                                    {{$icon}} {{.Player.FirstName}} {{.Player.LastName}}{{$remainingText}}
                                </button>
                            </form>
                            {{end}}
                        </div>
                    </div>
                    {{else}}
                    <p class="no-players">No other available players found.</p>
                    {{end}}
                </div>
            </div>
        </div>
    </main>

    <!-- Configuration from Go template (use data attributes to avoid linter issues) -->
    <div id="js-config" 
         data-fixture-id="{{.FixtureDetail.ID}}" 
         data-managing-team-id="{{if .ManagingTeam}}{{.ManagingTeam.ID}}{{else}}0{{end}}">
    </div>
    
    <script>
        // Global variables
        let draggedPlayer = null;
        let draggedFrom = null;
        let touchStartPos = null;
        let touchTarget = null;
        let isDragging = false;
        let touchStartTime = null;
        let longPressTimer = null;
        let isLongPress = false;
        let captainSelectionMode = false;
        let forcedSelectionEnabled = false;
        
        const LONG_PRESS_DURATION = 50; // Very short delay for mobile responsiveness
        
        // Configuration (set on DOMContentLoaded from data attributes)
        let FIXTURE_ID = null;
        let MANAGING_TEAM_ID = null;
        
        // Forced selection helpers
        function initializeForcedSelectionToggle() {
            const toggle = document.getElementById('forced-selection-toggle');
            if (!toggle) return;
            toggle.checked = !!forcedSelectionEnabled;
            toggle.onchange = function() {
                setForcedSelectionEnabled(toggle.checked);
            };
            applyForcedSelectionState();
        }

        function setForcedSelectionEnabled(enabled) {
            forcedSelectionEnabled = !!enabled;
            document.body.classList.toggle('forced-selection-mode', forcedSelectionEnabled);
            const toggle = document.getElementById('forced-selection-toggle');
            if (toggle && toggle.checked !== forcedSelectionEnabled) {
                toggle.checked = forcedSelectionEnabled;
            }
            applyForcedSelectionState();
        }

        function applyForcedSelectionState() {
            const blockedButtons = document.querySelectorAll('.btn-add-player.btn-blocked');
            blockedButtons.forEach(btn => {
                if (forcedSelectionEnabled) {
                    btn.removeAttribute('disabled');
                    btn.classList.add('forced-enabled');
                    if (btn.title && !btn.title.includes('Override')) {
                        btn.title = btn.title + ' | Override enabled';
                    }
                } else {
                    btn.setAttribute('disabled', '');
                    btn.classList.remove('forced-enabled');
                }
            });
        }

        // Day Captain Selection Functions
        function toggleCaptainSelection() {
            captainSelectionMode = !captainSelectionMode;
            const btn = document.getElementById('captain-selector-btn');
            
            if (captainSelectionMode) {
                btn.textContent = '‚úï Cancel Captain Selection';
                btn.classList.add('active');
                
                // Add captain selection mode class to hide crosses
                document.body.classList.add('captain-selection-mode');
                
                // Hide all remove buttons
                document.querySelectorAll('.player-remove-btn').forEach(btn => {
                    btn.style.display = 'none';
                });
                
                // Make all player cards selectable
                document.querySelectorAll('.player-card').forEach(card => {
                    card.classList.add('captain-selectable');
                    card.onclick = function() {
                        selectDayCaptain(card.dataset.playerId);
                    };
                });
            } else {
                btn.textContent = 'üë®‚Äç‚úàÔ∏è Select Day Captain';
                btn.classList.remove('active');
                
                // Remove captain selection mode class to show crosses
                document.body.classList.remove('captain-selection-mode');
                
                // Show all remove buttons
                document.querySelectorAll('.player-remove-btn').forEach(btn => {
                    btn.style.display = 'flex';
                });
                
                // Remove selectable styling from all player cards
                document.querySelectorAll('.player-card').forEach(card => {
                    card.classList.remove('captain-selectable');
                    // Restore original click handlers for matchup zone cards
                    if (card.closest('.matchup-zone')) {
                        const matchupType = card.closest('.matchup-zone').dataset.matchupType;
                        card.onclick = function() {
                            removePlayer(card.dataset.playerId, matchupType);
                        };
                    } else {
                        card.onclick = null;
                    }
                });
            }
        }
        
        function selectDayCaptain(playerId) {
            // Send server request to set day captain
            let bodyParams = 'action=set_day_captain&player_id=' + encodeURIComponent(playerId);
            if (MANAGING_TEAM_ID) {
                bodyParams += '&managing_team_id=' + MANAGING_TEAM_ID;
            }
            
            fetch('/admin/fixtures/' + FIXTURE_ID + '/matchup-selection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'HX-Request': 'true'
                },
                body: bodyParams
            })
            .then(response => {
                if (response.ok) {
                    // Update UI immediately
                    updateDayCaptainDisplay(playerId);
                    // Exit captain selection mode
                    toggleCaptainSelection();
                } else {
                    console.error('Failed to set day captain');
                }
            })
            .catch(error => {
                console.error('Error setting day captain:', error);
            });
        }
        
        function updateDayCaptainDisplay(newCaptainId) {
            // Remove captain styling from all players
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('is-captain');
                const nameSpan = card.querySelector('.player-name');
                if (nameSpan) {
                    // Remove existing captain indicator
                    const existingIndicator = nameSpan.querySelector('.captain-indicator');
                    if (existingIndicator) {
                        existingIndicator.remove();
                    }
                }
            });
            
            // Add captain styling to the new captain
            document.querySelectorAll(`[data-player-id="${newCaptainId}"]`).forEach(card => {
                card.classList.add('is-captain');
                const nameSpan = card.querySelector('.player-name');
                if (nameSpan) {
                    const captainIndicator = document.createElement('span');
                    captainIndicator.className = 'captain-indicator';
                    captainIndicator.textContent = '(C)';
                    nameSpan.appendChild(captainIndicator);
                }
            });
        }
        
        // Drag and drop handlers
        function handleDragStart(event, playerId, playerName, source) {
            // Don't allow drag during captain selection mode
            if (captainSelectionMode) {
                event.preventDefault();
                return;
            }
            
            draggedPlayer = {
                id: playerId,
                name: playerName,
                element: event.target,
                source: source
            };
            draggedFrom = source;
            event.target.classList.add('dragging');
            
            // Set drag data
            event.dataTransfer.setData('text/plain', playerId);
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const zone = event.currentTarget;
            zone.classList.add('drag-over');
        }
        
        function handleDragLeave(event) {
            const zone = event.currentTarget;
            zone.classList.remove('drag-over');
        }
        
        function handleDrop(event, target) {
            event.preventDefault();
            
            const zone = event.currentTarget;
            zone.classList.remove('drag-over');
            
            if (!draggedPlayer) return;
            
            // Don't drop on the same source
            if (draggedPlayer.source === target) return;
            
            // Move the player
            movePlayer(draggedPlayer.id, draggedPlayer.name, draggedPlayer.source, target);
            
            // Reset drag state
            if (draggedPlayer.element) {
                draggedPlayer.element.classList.remove('dragging');
            }
            draggedPlayer = null;
            draggedFrom = null;
        }
        
        // Touch event handlers for mobile
        function setupTouchEvents() {
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: false });
            document.addEventListener('touchcancel', resetTouchState, { passive: false });
            
            // Reset touch state if page loses focus
            window.addEventListener('blur', resetTouchState);
            window.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    resetTouchState();
                }
            });
        }
        
        function handleTouchStart(event) {
            // Don't interfere with remove button clicks
            if (event.target.closest('.player-remove-btn')) {
                console.log('Touch on remove button - ignoring');
                return;
            }
            
            const target = event.target.closest('.player-card');
            if (!target) return;
            
            // Handle captain selection mode
            if (captainSelectionMode) {
                selectDayCaptain(target.dataset.playerId);
                return;
            }
            
            // Don't interfere with matchup zone player cards (they're clickable, not draggable)
            if (target.closest('.matchup-zone')) {
                console.log('Touch on matchup zone player card - ignoring for drag');
                return;
            }
            
            console.log('Touch started on player card:', target.dataset.playerName);
            
            touchStartPos = {
                x: event.touches[0].clientX,
                y: event.touches[0].clientY
            };
            touchTarget = target;
            touchStartTime = Date.now();
            isLongPress = false;
            isDragging = false;
            
            // Clear any existing timer
            if (longPressTimer) {
                clearTimeout(longPressTimer);
            }
            
            // Very short delay to differentiate from accidental touches
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                touchTarget.classList.add('mobile-drag-ready');
                console.log('Long press detected - ready to drag');
                
                // Haptic feedback if available
                if (navigator.vibrate) {
                    navigator.vibrate(30);
                }
            }, LONG_PRESS_DURATION);
            
            // Don't prevent default immediately - allow scrolling
        }
        
        function handleTouchMove(event) {
            if (!touchTarget || !touchStartPos) return;
            
            // Don't interfere with remove button interactions
            if (event.target.closest('.player-remove-btn')) {
                return;
            }
            
            const touch = event.touches[0];
            const deltaX = touch.clientX - touchStartPos.x;
            const deltaY = touch.clientY - touchStartPos.y;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            
            // Start dragging immediately on any movement after short delay or if already in long press
            if (isLongPress || Date.now() - touchStartTime > LONG_PRESS_DURATION) {
                if (!isDragging) {
                    // Start dragging immediately
                    console.log('Starting drag for player:', touchTarget.dataset.playerName, 'distance:', distance);
                    isDragging = true;
                    isLongPress = true; // Force long press state
                    touchTarget.classList.add('dragging', 'mobile-drag-ready');
                    
                    // Prevent scrolling once drag starts
                    event.preventDefault();
                    
                    // Clear any pending timer
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                    }
                    
                    // Haptic feedback if available
                    if (navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                }
            }
            
            if (isDragging) {
                event.preventDefault();
                touchTarget.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                
                // Find drop zone under finger
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const dropZone = elementBelow ? elementBelow.closest('.selected-players-zone, .matchup-zone') : null;
                
                // Update visual feedback
                document.querySelectorAll('.drag-over').forEach(zone => zone.classList.remove('drag-over'));
                if (dropZone) {
                    dropZone.classList.add('drag-over');
                }
            }
        }
        
        function handleTouchEnd(event) {
            if (!touchTarget) return;
            
            // Clear long press timer
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            
            // Don't interfere with remove button clicks
            if (event.target.closest('.player-remove-btn')) {
                console.log('Touch ended on remove button - allowing click');
                // Reset touch state and let the button click work normally
                resetTouchState();
                return;
            }
            
            if (isDragging) {
                console.log('Touch ended while dragging player:', touchTarget.dataset.playerName);
                const touch = event.changedTouches[0];
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const dropZone = elementBelow ? elementBelow.closest('.selected-players-zone, .matchup-zone') : null;
                
                if (dropZone) {
                    const playerId = touchTarget.dataset.playerId;
                    const playerName = touchTarget.dataset.playerName;
                    const source = getPlayerSource(touchTarget);
                    const target = getDropZoneTarget(dropZone);
                    
                    console.log('Dropping player:', playerName, 'from:', source, 'to:', target);
                    
                    if (source !== target) {
                        movePlayer(playerId, playerName, source, target);
                    } else {
                        console.log('Same source and target - no move needed');
                    }
                } else {
                    console.log('No valid drop zone found');
                }
            } else {
                console.log('Touch ended without drag - normal tap');
            }
            
            // Reset visual state
            resetTouchState();
        }
        
        function getPlayerSource(element) {
            if (element.closest('#selected-players-container')) {
                return 'selected';
            } else if (element.closest('.matchup-zone')) {
                return element.closest('.matchup-zone').dataset.matchupType;
            }
            return null;
        }
        
        function getDropZoneTarget(zone) {
            if (zone.id === 'selected-players-zone') {
                return 'selected';
            } else if (zone.classList.contains('matchup-zone')) {
                return zone.dataset.matchupType;
            }
            return null;
        }
        
        function resetTouchState() {
            if (touchTarget) {
                touchTarget.style.transform = '';
                touchTarget.classList.remove('dragging', 'mobile-drag-ready');
            }
            document.querySelectorAll('.drag-over').forEach(zone => zone.classList.remove('drag-over'));
            hideDragInstruction();
            
            touchTarget = null;
            touchStartPos = null;
            isDragging = false;
            isLongPress = false;
            touchStartTime = null;
            
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function showDragInstruction() {
            let instruction = document.querySelector('.drag-instruction');
            if (!instruction) {
                instruction = document.createElement('div');
                instruction.className = 'drag-instruction';
                instruction.textContent = 'Drag to move player';
                document.body.appendChild(instruction);
            }
            instruction.classList.add('show');
        }
        
        function hideDragInstruction() {
            const instruction = document.querySelector('.drag-instruction');
            if (instruction) {
                instruction.classList.remove('show');
            }
        }
        
        // Player movement functions
        function movePlayer(playerId, playerName, source, target) {
            console.log(`Moving player ${playerName} from ${source} to ${target}`);
            
            // Determine if this is a move or copy operation
            const isCopyOperation = (source === 'selected' && target !== 'selected');
            
            // Update UI immediately for better UX
            updatePlayerUI(playerId, playerName, source, target, isCopyOperation);
            
            // Send server request
            if (target === 'selected') {
                // Moving to team selection
                addPlayerToTeamSelection(playerId);
            } else {
                // Assigning to matchup (keeping in selected players too)
                assignPlayerToMatchup(playerId, target);
            }
        }
        
        function updatePlayerUI(playerId, playerName, source, target, isCopyOperation = false) {
            const sourceElement = document.querySelector(`[data-player-id="${playerId}"]`);
            if (!sourceElement) return;
            
            // For copy operations, don't remove from source
            if (!isCopyOperation) {
                sourceElement.remove();
            }
            
            // Get availability from source element
            const availability = sourceElement.dataset.availability || 'unknown';
            
            // Add to target
            const playerCard = createPlayerCard(playerId, playerName, availability, target);
            
            if (target === 'selected') {
                const container = document.getElementById('selected-players-container');
                const noSelection = container.querySelector('.no-selection');
                if (noSelection) noSelection.remove();
                container.appendChild(playerCard);
            } else {
                // Find the matchup zone
                const matchupZones = document.querySelectorAll('.matchup-zone');
                for (let zone of matchupZones) {
                    if (zone.dataset.matchupType === target) {
                        const playersContainer = zone.querySelector('.matchup-players');
                        
                        // Check if player is already in this matchup
                        const existingPlayer = playersContainer.querySelector(`[data-player-id="${playerId}"]`);
                        if (existingPlayer) {
                            console.log(`Player ${playerName} is already in ${target} matchup`);
                            return; // Don't add duplicate
                        }
                        
                        playersContainer.appendChild(playerCard);
                        updateMatchupLimit(zone);
                        break;
                    }
                }
            }
            
            // Update progress (only if not a copy operation)
            if (!isCopyOperation) {
                updateProgress();
            }
        }
        
        function createPlayerCard(playerId, playerName, availability, context) {
            const div = document.createElement('div');
            div.className = `player-card availability-${availability}`;
            div.dataset.playerId = playerId;
            div.dataset.playerName = playerName;
            div.dataset.availability = availability;
            
            if (context === 'selected') {
                // Selected players zone - enable drag and add remove button
                div.draggable = true;
                div.ondragstart = function(e) { 
                    handleDragStart(e, playerId, playerName, context); 
                };
                div.innerHTML = `
                    <span class="player-name">${playerName}</span>
                    <button class="player-remove-btn" onclick="removePlayer('${playerId}', '${context}')" title="Remove">√ó</button>
                `;
            } else {
                // Matchup zones - no drag, click to remove
                div.draggable = false;
                div.onclick = function() { 
                    removePlayer(playerId, context); 
                };
                div.title = "Tap to remove from matchup";
                div.innerHTML = `<span class="player-name">${playerName}</span>`;
            }
            
            return div;
        }
        
        function updateMatchupLimit(zone) {
            const players = zone.querySelectorAll('.player-card');
            const limit = zone.querySelector('.player-limit');
            const count = players.length;
            
            limit.textContent = `${count}/2`;
            
            // Update zone styling based on player count
            zone.classList.remove('full', 'over-limit');
            if (count > 2) {
                zone.classList.add('over-limit');
            }
        }
        
        function updateProgress() {
            const selectedCount = document.querySelectorAll('#selected-players-container .player-card').length;
            const progressText = document.querySelector('.progress-text');
            const progressFill = document.querySelector('.progress-fill');
            
            progressText.textContent = `Players Selected: ${selectedCount}/8`;
            const percentage = (selectedCount * 100) / 8;
            progressFill.style.width = `${percentage}%`;
        }
        
        // Button click handlers (now handled by HTMX forms)
        
        function removePlayer(playerId, context) {
            // Don't allow removal during captain selection mode
            if (captainSelectionMode) {
                console.log('Cannot remove player during captain selection mode');
                return;
            }
            
            if (context !== 'selected') {
                // For matchup removal, just reload the page after making the request
                // This is simpler and avoids HTMX container replacement issues
                let bodyParams = 'action=remove_player&player_id=' + encodeURIComponent(playerId) + '&matchup_type=' + encodeURIComponent(context);
                if (MANAGING_TEAM_ID) {
                    bodyParams += '&managing_team_id=' + MANAGING_TEAM_ID;
                }
                
                fetch('/admin/fixtures/' + FIXTURE_ID + '/matchup-selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'HX-Request': 'true'
                    },
                    body: bodyParams
                })
                .then(() => {
                    // Reload page to show updated state
                    window.location.reload();
                });
            } else {
                // For team selection removal, create a form that exactly matches the template forms
                const form = document.createElement('form');
                form.method = 'post';
                form.style.display = 'none';
                form.action = '/admin/fixtures/' + FIXTURE_ID + '/team-selection';
                
                // Set HTMX attributes to match the template forms
                form.setAttribute('hx-post', form.action);
                form.setAttribute('hx-target', '.team-selection-container');
                form.setAttribute('hx-swap', 'outerHTML');
                
                // Add hidden inputs
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'remove_player';
                form.appendChild(actionInput);
                
                const playerInput = document.createElement('input');
                playerInput.type = 'hidden';
                playerInput.name = 'player_id';
                playerInput.value = playerId;
                form.appendChild(playerInput);
                
                if (MANAGING_TEAM_ID) {
                    const teamInput = document.createElement('input');
                    teamInput.type = 'hidden';
                    teamInput.name = 'managing_team_id';
                    teamInput.value = MANAGING_TEAM_ID;
                    form.appendChild(teamInput);
                }
                
                // Create a submit button for HTMX to work with
                const submitButton = document.createElement('button');
                submitButton.type = 'submit';
                submitButton.style.display = 'none';
                form.appendChild(submitButton);
                
                // Add to DOM and let HTMX process it
                document.body.appendChild(form);
                
                // Let HTMX process the form to set up the event handlers
                if (window.htmx) {
                    htmx.process(form);
                    // Click the submit button to trigger HTMX
                    submitButton.click();
                } else {
                    // Fallback if HTMX isn't available
                    form.submit();
                }
                
                // Clean up the form after a short delay
                setTimeout(() => {
                    if (form.parentNode) {
                        document.body.removeChild(form);
                    }
                }, 500);
            }
        }
        
        // Server communication functions
        function addPlayerToTeamSelection(playerId) {
            let bodyParams = 'action=add_player&player_id=' + encodeURIComponent(playerId) + '&is_home=true';
            if (MANAGING_TEAM_ID) {
                bodyParams += '&managing_team_id=' + MANAGING_TEAM_ID;
            }
            
            fetch('/admin/fixtures/' + FIXTURE_ID + '/team-selection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'HX-Request': 'true'
                },
                body: bodyParams
            });
        }
        
        function assignPlayerToMatchup(playerId, matchupType) {
            let bodyParams = 'action=assign_player&player_id=' + encodeURIComponent(playerId) + '&matchup_type=' + encodeURIComponent(matchupType);
            if (MANAGING_TEAM_ID) {
                bodyParams += '&managing_team_id=' + MANAGING_TEAM_ID;
            }
            
            fetch('/admin/fixtures/' + FIXTURE_ID + '/matchup-selection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'HX-Request': 'true'
                },
                body: bodyParams
            });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupTouchEvents();
            
            // Read config from data attributes
            const cfgEl = document.getElementById('js-config');
            if (cfgEl) {
                const fId = parseInt(cfgEl.dataset.fixtureId, 10);
                FIXTURE_ID = isNaN(fId) ? null : fId;
                const mtid = parseInt(cfgEl.dataset.managingTeamId, 10);
                MANAGING_TEAM_ID = isNaN(mtid) || mtid === 0 ? null : mtid;
            }

            // Set initial progress width from server-provided percentage
            const progressFillEl = document.querySelector('.progress-fill');
            if (progressFillEl && progressFillEl.hasAttribute('data-percentage')) {
                const p = parseInt(progressFillEl.getAttribute('data-percentage') || '0', 10);
                progressFillEl.style.width = `${p}%`;
            }

            // Update matchup limits on page load
            document.querySelectorAll('.matchup-zone').forEach(updateMatchupLimit);
            
            // Add drag leave handlers
            document.querySelectorAll('.selected-players-zone, .matchup-zone').forEach(zone => {
                zone.addEventListener('dragleave', handleDragLeave);
            });
            
            // Add visual feedback for mobile users
            if (window.innerWidth <= 768) {
                console.log('Mobile device detected - using touch-optimized drag and drop');
            }
            
            // Initialize forced selection toggle
            initializeForcedSelectionToggle();

            console.log('Team selection with drag and drop and day captain selection initialized');
        });
        
        // Also run when HTMX updates the content
        document.addEventListener('htmx:afterSwap', function(event) {
            // Only run if the team-selection-container was updated
            if (event.target.classList && event.target.classList.contains('team-selection-container')) {
                console.log('HTMX updated team selection container - updating matchup limits');
                // Update immediately without delay to prevent flicker
                document.querySelectorAll('.matchup-zone').forEach(updateMatchupLimit);
                // Recompute progress after swap
                updateProgress();
                // Re-bind forced selection toggle and re-apply state
                initializeForcedSelectionToggle();
            }
        });
    </script>
</body>
</html> 